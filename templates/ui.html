<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body { background: #0f172a0d; }
      .hero { background: linear-gradient(120deg, #1d4ed8, #0f172a); color: #f8fafc; border-radius: 1rem; padding: 2rem 2.5rem; margin-bottom: 2rem; }
      .hero p { margin-bottom: 0.5rem; }
      .card { border-radius: 0.85rem; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08); }
      .badge-status { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08rem; }
      .status-running { background: #fde68a; color: #92400e; }
      .status-completed { background: #bbf7d0; color: #166534; }
      .status-error { background: #fecaca; color: #991b1b; }
      .status-queued { background: #e0f2fe; color: #075985; }
      .table thead th { background: #f1f5f9; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.08rem; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="hero">
        <h1 class="display-6 fw-semibold mb-3">ReconScript Local UI</h1>
        <p>Runs strictly on <strong>127.0.0.1</strong>. Keep scans within approved, non-public targets.</p>
        <p class="mb-0">Reports render directly from local disk — no data leaves your workstation.</p>
      </div>

      {% if message %}
        <div class="alert alert-warning" role="alert">{{ message }}</div>
      {% endif %}

      {% if view == 'dashboard' %}
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="card h-100">
              <div class="card-body">
                <h2 class="h5 fw-semibold">Start a scan</h2>
                <p class="text-muted">Targets default to localhost. External IPs are rejected unless you tick the override.</p>
                <form method="post" action="{{ url_for('start_job') }}" class="mt-3">
                  <div class="mb-3">
                    <label for="target" class="form-label">Target IP / Host</label>
                    <input type="text" class="form-control" id="target" name="target" value="127.0.0.1" required />
                  </div>
                  <div class="mb-3">
                    <label for="ports" class="form-label">Ports (space separated)</label>
                    <input type="text" class="form-control" id="ports" name="ports" value="80 443 3000" />
                  </div>
                  <div class="row">
                    <div class="col">
                      <label for="socket_timeout" class="form-label">Socket timeout (s)</label>
                      <input type="number" step="0.1" class="form-control" id="socket_timeout" name="socket_timeout" value="3" />
                    </div>
                    <div class="col">
                      <label for="http_timeout" class="form-label">HTTP timeout (s)</label>
                      <input type="number" step="0.1" class="form-control" id="http_timeout" name="http_timeout" value="8" />
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col">
                      <label for="throttle" class="form-label">Throttle (s)</label>
                      <input type="number" step="0.1" class="form-control" id="throttle" name="throttle" value="0.2" />
                    </div>
                    <div class="col">
                      <label for="format" class="form-label">Format</label>
                      <select class="form-select" id="format" name="format">
                        <option value="html" selected>HTML</option>
                        <option value="json">JSON</option>
                        <option value="markdown">Markdown</option>
                        <option value="pdf">PDF</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" value="1" id="allow_external" name="allow_external" />
                    <label class="form-check-label" for="allow_external">Allow non-local / public targets (you accept responsibility)</label>
                  </div>
                  <button class="btn btn-primary mt-3" type="submit">Run Scan</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-7">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h2 class="h5 fw-semibold mb-0">Recent jobs</h2>
                  <small class="text-muted">Auto-refresh manually by reloading this page.</small>
                </div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Format</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for job in jobs %}
                        <tr>
                          <td><code>{{ job.id }}</code></td>
                          <td>{{ job.target }}</td>
                          <td>
                            <span class="badge badge-status status-{{ job.status }}">{{ job.status.title() }}</span>
                          </td>
                          <td>{{ job.started or 'pending' }}</td>
                          <td>{{ job.format|upper }}</td>
                          <td>
                            <a class="btn btn-link btn-sm" href="{{ url_for('job_status', job_id=job.id) }}">View</a>
                          </td>
                        </tr>
                      {% else %}
                        <tr>
                          <td colspan="6" class="text-center text-muted py-4">No jobs yet. Launch your first scan above.</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      {% if view == 'job' %}
        <a href="{{ url_for('index') }}" class="btn btn-link mb-3">&larr; Back to dashboard</a>
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h2 class="h4 mb-1">Job {{ job.id }}</h2>
                <p class="text-muted mb-0">Target {{ job.target }} · Ports {{ job.ports }}</p>
              </div>
              <div>
                <span class="badge badge-status status-{{ job.status }}">{{ job.status.title() }}</span>
              </div>
            </div>
            <dl class="row mt-4">
              <dt class="col-sm-3">Requested format</dt>
              <dd class="col-sm-9">{{ job.format|upper }}</dd>
              <dt class="col-sm-3">Started</dt>
              <dd class="col-sm-9">{{ job.started or 'pending' }}</dd>
              <dt class="col-sm-3">Finished</dt>
              <dd class="col-sm-9">{{ job.finished or 'in progress' }}</dd>
            </dl>
            {% if job.warning %}
              <div class="alert alert-warning" role="alert">{{ job.warning }}</div>
            {% endif %}
            {% if job.error %}
              <div class="alert alert-danger" role="alert">{{ job.error }}</div>
            {% endif %}
            {% if job.outputs %}
              <h3 class="h5 mt-4">Reports</h3>
              <ul class="list-group list-group-flush">
                {% for label, path in job.outputs.items() %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ label.upper() }}</span>
                    <a href="{{ path }}" class="link-primary" target="_blank" rel="noopener">Open</a>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mt-4">No output yet — refresh after the job completes.</p>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </body>
</html>
